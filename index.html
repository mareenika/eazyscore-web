<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>EAZY Score</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="./css/style.css" rel="stylesheet">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    form .question{display:flex;gap:12px;align-items:center;margin:.5rem 0;flex-wrap:wrap}
    .inline-label{min-width:280px;font-weight:600}
    .inline-field select,.inline-field input{padding:.5rem;border:1px solid #ccc;border-radius:8px}
    fieldset{border:1px solid #e2e8f0;border-radius:12px;padding:1rem;margin:1rem 0}
    legend{font-weight:700}
    .hidden{display:none}
    .note{margin:.5rem 0;color:#555;font-size:.95em}
    .warn{color:#a33}
    .success{color:green}
    .muted{color:#6b7280}

    /* Buttons & Layout symmetrisch */
    .toolbar{display:flex;gap:.75rem;align-items:center;flex-wrap:wrap;margin:1rem 0;justify-content:center}
    .footer{display:flex;gap:.75rem;justify-content:center;margin-top:1rem}
    .btn{padding:.55rem 1rem;border:1px solid #d1d5db;border-radius:10px;background:#fff;cursor:pointer;font-size:.95rem}
    .btn:hover{background:#f9fafb}
    .btn-primary{background:#111827;color:#fff;border-color:#111827}
    .btn-primary:hover{filter:brightness(1.1)}
    .btn-danger{border-color:#ef4444;color:#ef4444}
    .btn-danger:hover{background:#fff5f5}

    /* Progress */
    .progress-wrapper{margin-top:1rem}
    .progress-title{font-weight:600;margin-bottom:.4rem;text-align:center}
    .progress-container{background:#e5e7eb;border-radius:10px;overflow:hidden}
    .progress-bar{height:28px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600}

    /* Ergebniskarte */
    .top-row{display:flex;gap:16px;justify-content:center;margin-bottom:.25rem}
    .score-value{font-size:2rem;font-weight:800}
    .grade-badge{font-size:2rem;font-weight:800}
    .grade-A{background:#16a34a}.grade-B{background:#22c55e}
    .grade-C{background:#84cc16}.grade-D{background:#eab308}
    .grade-E{background:#f59e0b}.grade-F{background:#ef4444}

    /* Container */
    .container{max-width:1000px;margin:0 auto;padding:1rem}
    .section{margin-top:1.25rem}
  </style>
</head>
<body>
  <div class="container">
    <h1>EAZY Score</h1>
    <p class="note">Öffentliche Liste ansehen: <a href="./public.html">Letzte Bewertungen</a></p>

    <!-- LOGIN (E-Mail/Passwort) -->
    <form id="loginForm" style="margin:1rem 0;border:1px solid #e5e7eb;padding:1rem;border-radius:12px;">
      <label for="emailInput">E-Mail:
        <input id="emailInput" type="email" placeholder="you@example.com" required>
      </label>
      <label for="pwInput" style="margin-left:.5rem">Passwort:
        <input id="pwInput" type="password" required>
      </label>
      <button id="btnLogin" type="submit" class="btn btn-primary">Anmelden</button>
      <div id="loginHint" class="note"></div>
    </form>

    <!-- Status + Logout -->
    <div id="loginStatus" style="display:none;margin:1rem 0;font-weight:600;color:green;align-items:center;">
      <span id="loginUser">Superadmin</span>
      <button id="btnLogout" type="button" class="btn" style="margin-left:1rem;">Logout</button>
    </div>

    <!-- Hinweis für Nicht-Admins -->
    <div id="adminNote" class="note warn hidden">
      Du bist eingeloggt, aber kein Admin. Bewertungen können nur Admins erstellen.
      Ergebnisse siehst du hier: <a href="./public.html">Letzte Bewertungen</a>.
    </div>

    <!-- Admin-Toolbar -->
    <div id="adminToolbar" class="toolbar" style="display:none">
      <button id="btnNewAssessmentTop" type="button" class="btn btn-primary">+ Neue Bewertung</button>
      <button type="button" class="btn" onclick="location.href='./public.html'">Öffentliche Übersicht öffnen</button>
    </div>

    <!-- FORMULAR -->
    <form id="auditForm" novalidate style="display:none;">
      <fieldset>
        <legend>App-Details</legend>
        <div class="fieldstack">
          <label for="appName">App-Name</label>
          <input id="appName" name="appName" placeholder="z. B. WhatsApp">
        </div>
        <div class="fieldstack">
          <label for="version">Version</label>
          <input id="version" name="version" placeholder="z. B. 2.24.XX">
        </div>
        <div class="fieldstack">
          <label for="category">Kategorie</label>
          <input id="category" name="category" placeholder="z. B. Kommunikation">
        </div>
      </fieldset>

      <fieldset>
        <legend>Antwortmöglichkeiten (Ja / Nein / Unbekannt)</legend>
        <div id="questions"></div>
      </fieldset>

      <div class="footer">
        <button type="submit" class="btn btn-primary">Bewerten</button>
        <button type="button" id="btnClear" class="btn">Zurücksetzen</button>
      </div>
    </form>

    <!-- ERGEBNIS -->
    <section id="resultSection" class="score-card hidden" aria-live="polite">
      <div class="top-row">
        <div class="score-block" style="text-align:center">
          <div class="score-label muted">Gesamt-Score</div>
          <div id="scoreValue" class="score-value">0%</div>
          <div class="small-meta"><span id="correctMeta">0 von 0 richtigen Antworten</span></div>
        </div>
        <div class="grade-block" style="text-align:center">
          <div class="grade-label muted">Note</div>
          <div id="gradeBadge" class="grade-badge grade-F" style="padding:.1rem .6rem;border-radius:10px;color:#fff;display:inline-block">F</div>
        </div>
      </div>

      <div class="progress-wrapper">
        <div class="progress-title">Prozessfortschritt</div>
        <div class="progress-container">
          <div id="progressBar" class="progress-bar grade-F" style="width:0%;background:#ef4444;">
            <span id="progressText">0/0</span>
          </div>
        </div>
      </div>

      <div class="meta-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:.9rem">
        <div class="meta-col">
          <div class="section-title">App-Details</div>
          <div><span class="label-key">App-Name: </span><span id="rAppName">–</span></div>
          <div><span class="label-key">Version: </span><span id="rVersion">–</span></div>
          <div><span class="label-key">Kategorie: </span><span id="rCategory">–</span></div>
        </div>
        <div class="meta-col">
          <div class="section-title">Kurzbefunde</div>
          <div id="shortFindings"></div>
        </div>
      </div>

      <div class="footer">
        <button id="restartBtn" class="btn btn-primary">+ Neue Bewertung</button>
        <button type="button" class="btn" onclick="location.href='./public.html'">Öffentliche Übersicht</button>
      </div>
    </section>
  </div>

  <!-- App-Logik (rendert 37 Fragen & feuert eazy:result) -->
  <script src="./js/app.js"></script>

  <!-- Supabase + Admin-Funktionen -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js";

    const supabase = createClient(
      "https://lhdztkfvrnsqfnbqybfq.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxoZHp0a2Z2cm5zcWZuYnF5YmZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczMjIxMjMsImV4cCI6MjA3Mjg5ODEyM30.81BVX5zf_WxE3RdTw32OttwsiMgDanXdNIkWeug-jUs"
    );

    const loginForm   = document.getElementById('loginForm');
    const loginHint   = document.getElementById('loginHint');
    const loginStatus = document.getElementById('loginStatus');
    const btnLogout   = document.getElementById('btnLogout');
    const auditForm   = document.getElementById('auditForm');
    const adminNote   = document.getElementById('adminNote');
    const adminToolbar= document.getElementById('adminToolbar');
    const restartBtn  = document.getElementById('restartBtn');
    const btnNewAssessmentTop = document.getElementById('btnNewAssessmentTop');
    const btnClear = document.getElementById('btnClear');

    function setLoggedInUI(){
      loginForm.style.display='none';
      loginStatus.style.display='flex';
      document.getElementById('loginUser').textContent = 'Superadmin'; // statt E-Mail
    }
    function setLoggedOutUI(){
      loginForm.style.display='block';
      loginStatus.style.display='none';
      auditForm.style.display='none';
      adminToolbar.style.display='none';
      adminNote.classList.add('hidden');
    }

    async function isAdmin(){
      const { data: { session } } = await supabase.auth.getSession();
      const uid = session?.user?.id;
      if (!uid) return false;
      const { data, error } = await supabase.from('admins').select('user_id').eq('user_id', uid).maybeSingle();
      return !!data && !error;
    }

    async function guardAdminUI(){
      const { data: { session } } = await supabase.auth.getSession();
      if (!session?.user){ setLoggedOutUI(); return; }
      if (await isAdmin()){
        auditForm.style.display = 'block';
        adminToolbar.style.display = 'flex';
        adminNote.classList.add('hidden');
      }else{
        auditForm.style.display = 'none';
        adminToolbar.style.display = 'none';
        adminNote.classList.remove('hidden');
      }
    }

    // Login
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('emailInput').value.trim();
      const pw    = document.getElementById('pwInput').value.trim();
      if (!email || !pw) return alert('Bitte E-Mail und Passwort eingeben.');
      const { error } = await supabase.auth.signInWithPassword({ email, password: pw });
      if (error){ loginHint.textContent = error.message; return; }
      setLoggedInUI();
      await guardAdminUI();
    });

    // Logout
    btnLogout.addEventListener('click', async () => {
      await supabase.auth.signOut();
      setLoggedOutUI();
    });

    // Initial
    (async ()=>{
      const { data: { session } } = await supabase.auth.getSession();
      if (session?.user) setLoggedInUI(); else setLoggedOutUI();
      await guardAdminUI();
    })();

    // „Neue Bewertung“ Buttons
    function startNewAssessment(){
      const r = document.getElementById('resultSection');
      const f = document.getElementById('auditForm');
      if (!r.classList.contains('hidden')){
        // app.js hängt bereits auf #restartBtn – das nutzt sauber das vorhandene Reset
        restartBtn.click();
      }else{
        f.reset();
        f.style.display='block';
        window.scrollTo({ top: f.offsetTop - 12, behavior: 'smooth' });
      }
    }
    btnNewAssessmentTop.addEventListener('click', startNewAssessment);
    restartBtn.addEventListener('click', startNewAssessment);
    btnClear.addEventListener('click', () => {
      document.getElementById('auditForm').reset();
    });

    // ====== Persistenz ======
    function slugify(s){return (s||'').toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');}

    async function getOrCreateApp({ bundleId, name, category }){
      const sel = await supabase.from('apps').select('*').eq('bundle_id', bundleId).limit(1);
      if (sel.error) throw sel.error;
      if (sel.data?.length) return sel.data[0];
      const ins = await supabase.from('apps').insert({ bundle_id: bundleId, name, category }).select().single();
      if (ins.error) throw ins.error;
      return ins.data;
    }

    async function saveAssessment({ appId, answers, totalScore, grade }){
      const ins = await supabase.from('assessments').insert({
        app_id: appId, answers, total_score: Math.round(totalScore||0), grade
      });
      if (ins.error) throw ins.error;
    }

    // Hört auf das Event aus app.js
    document.addEventListener('eazy:result', async (ev) => {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session?.user){ alert('Bitte einloggen.'); return; }
      if (!(await isAdmin())){ alert('Nur Admin darf speichern.'); return; }

      try{
        const { answers, score, grade, meta } = ev.detail;
        const appName  = (meta?.appName || '').trim() || 'Unbenannte App';
        const version  = (meta?.version || '').trim() || 'v1';
        const category = (meta?.category || '').trim() || null;
        const bundleId = slugify(`${appName}-${version}`);

        const app = await getOrCreateApp({ bundleId, name: appName, category });
        // Version im App-Datensatz aktualisieren, falls abweichend
        if ((app.version||'') !== version){
          const upd = await supabase.from('apps').update({ version }).eq('id', app.id);
          if (upd.error) throw upd.error;
        }

        await saveAssessment({ appId: app.id, answers, totalScore: score, grade });

        // ✅ Popup-Bestätigung + sanftes Reset für weitere Bewertung
        alert('✅ Bewertung erfolgreich gespeichert!');
        startNewAssessment();
      }catch(err){
        alert('❌ Fehler beim Speichern: ' + (err?.message || err));
      }
    });
  </script>
</body>
</html>
