<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>EAZY Score</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="./css/style.css" rel="stylesheet">
  <style>
    form .question{display:flex;gap:12px;align-items:center;margin:.5rem 0;flex-wrap:wrap}
    .inline-label{min-width:280px;font-weight:600}
    .inline-field select,.inline-field input{padding:.5rem;border:1px solid #ccc;border-radius:6px}
    fieldset{border:1px solid #e2e8f0;border-radius:8px;padding:1rem;margin:1rem 0}
    legend{font-weight:700}
    .hidden{display:none}
    .footer{display:flex;justify-content:flex-start}
  </style>
</head>
<body>
  <div class="container">
    <h1>EAZY Score</h1>

    <!-- LOGIN (OTP per E-Mail) -->
    <div id="loginBox" style="margin:1rem 0; border:1px solid #ddd; padding:1rem; border-radius:8px;">
      <div id="loginInputs">
        <label for="emailInput">E-Mail:
          <input id="emailInput" type="email" placeholder="you@example.com" required>
        </label>
        <button id="btnSendOtp" type="button">Code senden</button>

        <div style="margin-top:.75rem">
          <input id="otpInput" type="text" inputmode="numeric" pattern="[0-9]*"
                 maxlength="8" autocomplete="one-time-code" placeholder="8-stelliger Code">
          <button id="btnVerifyOtp" type="button">Code bestätigen</button>
        </div>

        <div id="loginHint" style="margin-top:.5rem;font-size:.9em;color:#555"></div>
      </div>

      <div id="loginStatus" style="display:none; margin-top:.5rem; font-weight:600; color:green"></div>
    </div>
    <!-- ENDE LOGIN -->

    <!-- FORMULAR -->
    <form id="auditForm" novalidate>
      <fieldset>
        <legend>App-Details</legend>
        <div class="fieldstack">
          <label for="appName">App-Name</label>
          <input id="appName" name="appName" placeholder="z. B. BeispielApp">
        </div>
        <div class="fieldstack">
          <label for="version">Version</label>
          <input id="version" name="version" placeholder="z. B. 1.0.0">
        </div>
        <div class="fieldstack">
          <label for="category">Kategorie</label>
          <input id="category" name="category" placeholder="z. B. Gesundheit">
        </div>
      </fieldset>

      <fieldset>
        <legend>Antwortmöglichkeiten (Ja / Nein / Unbekannt)</legend>
        <div id="questions"></div>
      </fieldset>

      <div class="footer">
        <button type="submit" class="btn-primary">Bewerten</button>
      </div>
    </form>

    <!-- ERGEBNIS -->
    <section id="resultSection" class="score-card hidden" aria-live="polite">
      <div class="top-row">
        <div class="score-block">
          <div class="score-label">Gesamt-Score</div>
          <div id="scoreValue" class="score-value">0%</div>
          <div class="small-meta"><span id="correctMeta">0 von 0 richtigen Antworten</span></div>
        </div>
        <div class="grade-block">
          <div class="grade-label">Note</div>
          <div id="gradeBadge" class="grade-badge grade-F">F</div>
        </div>
      </div>

      <div class="progress-wrapper" aria-label="Score Fortschritt">
        <div class="progress-container">
          <div id="progressBar" class="progress-bar grade-F" style="width:0%;">
            <span id="progressText">0/0</span>
          </div>
        </div>
      </div>

      <div class="meta-grid">
        <div class="meta-col">
          <div class="section-title">App-Details</div>
          <div><span class="label-key">App-Name: </span><span id="rAppName">–</span></div>
          <div><span class="label-key">Version: </span><span id="rVersion">–</span></div>
          <div><span class="label-key">Kategorie: </span><span id="rCategory">–</span></div>
        </div>
        <div class="meta-col">
          <div class="section-title">Kurzbefunde</div>
          <div id="shortFindings"></div>
        </div>
      </div>

      <div class="footer">
        <button id="restartBtn" class="btn-primary" type="button">Neu bewerten</button>
      </div>
    </section>
  </div>

  <!-- Deine App-Logik -->
  <script src="./js/app.js"></script>

  <!-- Supabase-Login + Persistenz -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js";

    // === Supabase Setup ===
    const SUPABASE_URL  = "https://lhdztkfvrnsqfnbqybfq.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxoZHp0a2Z2cm5zcWZuYnF5YmZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczMjIxMjMsImV4cCI6MjA3Mjg5ODEyM30.81BVX5zf_WxE3RdTw32OttwsiMgDanXdNIkWeug-jUs";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

    // === UI Refs ===
    const loginBox   = document.getElementById('loginBox');
    const loginInputs= document.getElementById('loginInputs');
    const loginStatus= document.getElementById('loginStatus');
    const loginHint  = document.getElementById('loginHint');
    const emailEl    = document.getElementById('emailInput');
    const otpEl      = document.getElementById('otpInput');
    const sendBtn    = document.getElementById('btnSendOtp');
    const verifyBtn  = document.getElementById('btnVerifyOtp');

    // === State ===
    let lastEmailSent = null;
    let sendLockUntil = 0;

    const normalizeEmail = v => (v || '').trim().toLowerCase();

    // Fullwidth / arabische Ziffern -> ASCII 0–9
    function normalizeDigits(str) {
      if (!str) return '';
      str = str.replace(/[\uFF10-\uFF19]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFF10 + 0x30)); // fullwidth
      str = str.replace(/[\u0660-\u0669]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0x0660 + 0x30)); // arabic-indic
      str = str.replace(/[\u06F0-\u06F9]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0x06F0 + 0x30)); // eastern arabic
      return str;
    }
    function cleanToken(v) {
      return normalizeDigits(v || '')
        .replace(/[\u200B-\u200D\uFEFF]/g, '') // zero-width
        .replace(/[\u00A0\s\-_.,]/g, '')       // NBSP/Spaces/Trenner
        .replace(/[^0-9]/g, '')                // nur Ziffern
        .trim();
    }

    function setLoggedInUI(identity) {
      loginInputs.style.display = 'none';
      loginStatus.style.display = 'block';
      loginStatus.textContent = `Eingeloggt: ${identity}`;
    }
    function setLoggedOutUI() {
      loginInputs.style.display = 'block';
      loginStatus.style.display = 'none';
      loginStatus.textContent = '';
    }

    // ===== Enter-Key nur für Login benutzen =====
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && loginBox.contains(document.activeElement)) {
        // Enter aus Login-Bereich darf KEIN Formular-Submit auslösen
        e.preventDefault();
        e.stopPropagation();
        // Stattdessen OTP verifizieren
        verifyBtn.click();
      }
    });

    // ===== OTP Eingabe: nur 8 Ziffern, Paste säubern =====
    otpEl.setAttribute('maxlength','8');
    otpEl.addEventListener('input', () => {
      const cleaned = cleanToken(otpEl.value).slice(0, 8);
      if (otpEl.value !== cleaned) otpEl.value = cleaned;
    });
    otpEl.addEventListener('paste', e => {
      e.preventDefault();
      const text = (e.clipboardData || window.clipboardData).getData('text');
      otpEl.value = cleanToken(text).slice(0, 8);
    });

    // ===== Send-Button Sperre (60s) =====
    function startSendLock(seconds = 60) {
      sendLockUntil = Date.now() + seconds * 1000;
      updateSendButton();
      const tick = setInterval(() => {
        if (Date.now() >= sendLockUntil) {
          clearInterval(tick);
          updateSendButton();
        } else {
          updateSendButton();
        }
      }, 250);
    }
    function updateSendButton() {
      const now = Date.now();
      if (now < sendLockUntil) {
        const secs = Math.max(1, Math.ceil((sendLockUntil - now) / 1000));
        sendBtn.disabled = true;
        sendBtn.textContent = `Code senden (${secs}s)`;
      } else {
        sendBtn.disabled = false;
        sendBtn.textContent = 'Code senden';
      }
    }

    // ===== Code senden =====
    sendBtn.addEventListener('click', async () => {
      if (Date.now() < sendLockUntil) return;

      const email = normalizeEmail(emailEl.value);
      if (!email) return alert('Bitte E-Mail eingeben.');

      // E-Mail nach dem Senden fixieren (Verwechslungen vermeiden)
      emailEl.value = email;
      emailEl.readOnly = true;

      sendBtn.disabled = true;
      try {
        const { error } = await supabase.auth.signInWithOtp({ email });
        if (error) {
          alert(error.message);
          loginHint.textContent = '';
          emailEl.readOnly = false;
          return;
        }
        lastEmailSent = email;
        loginHint.textContent = `E-Mail gesendet an ${email}. Nutze den NEUESTEN 8-stelligen Code (ältere Codes werden ungültig).`;
        alert('Code gesendet. Prüfe deine E-Mail (neueste Nachricht) – dann Code hier eingeben.');
        otpEl.focus();
        startSendLock(60);
      } finally {
        // Entsperren übernimmt der Lock-Timer
      }
    });

    // ===== OTP verifizieren (mit Typ-Fallbacks) =====
    verifyBtn.addEventListener('click', async () => {
      const email = normalizeEmail(emailEl.value);
      const token = cleanToken(otpEl.value);

      if (!email || !token) return alert('E-Mail und Code eingeben.');
      if (token.length !== 8) return alert('Bitte den 8-stelligen Code vollständig eingeben.');
      if (lastEmailSent && email !== lastEmailSent) {
        return alert(`Diese E-Mail (${email}) unterscheidet sich von der Adresse, an die der Code gesendet wurde (${lastEmailSent}). Bitte korrigieren oder neuen Code senden.`);
      }

      const tryTypes = ['email', 'signup', 'recovery'];
      let finalError = null;
      for (const t of tryTypes) {
        const { error } = await supabase.auth.verifyOtp({ email, token, type: t });
        if (!error) { finalError = null; break; }
        finalError = error;
        if (!/invalid|expired/i.test(error.message)) break;
      }

      if (finalError) {
        if (/expired/i.test(finalError.message)) {
          alert('Code abgelaufen. Bitte neuen Code anfordern und sofort verwenden.');
        } else if (/invalid/i.test(finalError.message)) {
          alert('Code ungültig. Bitte NUR den neuesten Code aus der letzten E-Mail verwenden (kein älterer).');
        } else {
          alert(finalError.message);
        }
        return;
      }

      // Erfolg → UI sofort umschalten
      setLoggedInUI(email);
    });

    // ===== Status beim Laden/Änderungen =====
    async function updateStatus() {
      const { data: { session } } = await supabase.auth.getSession();
      const email = session?.user?.email;
      if (email) {
        setLoggedInUI(email);
        emailEl.value = email;
        emailEl.readOnly = true;
        sendLockUntil = 0;
        updateSendButton();
      } else {
        setLoggedOutUI();
        emailEl.readOnly = false;
      }
      return session?.user ?? null;
    }
    await updateStatus();
    supabase.auth.onAuthStateChange((_evt, session) => {
      const email = session?.user?.email;
      if (email) setLoggedInUI(email); else setLoggedOutUI();
    });

    // Initial
    updateSendButton();
  </script>
</body>
</html>
