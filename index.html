<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>EAZY Score</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="./css/style.css" rel="stylesheet">
  <style>
    /* kleine Form-Helfer, falls dein style.css das nicht hat */
    form .question{display:flex;gap:12px;align-items:center;margin:.5rem 0;flex-wrap:wrap}
    .inline-label{min-width:280px;font-weight:600}
    .inline-field select,.inline-field input{padding:.5rem;border:1px solid #ccc;border-radius:6px}
    fieldset{border:1px solid #e2e8f0;border-radius:8px;padding:1rem;margin:1rem 0}
    legend{font-weight:700}
    .hidden{display:none}
    .footer{display:flex;justify-content:flex-start}
  </style>
</head>
<body>
  <div class="container">
    <h1>EAZY Score</h1>

    <!-- LOGIN -->
    <div style="margin:1rem 0; border:1px solid #ddd; padding:1rem; border-radius:8px;">
      <label for="emailInput">E-Mail:
        <input id="emailInput" type="email" placeholder="you@example.com">
      </label>
      <button id="btnLoginEmail" type="button">Einloggen per E-Mail</button>
      <span id="loginStatus" style="margin-left:1rem;"></span>
    </div>
    <!-- ENDE LOGIN -->

    <!-- FORMULAR -->
    <form id="auditForm" novalidate>
      <fieldset>
        <legend>App-Details</legend>
        <div class="fieldstack">
          <label for="appName">App-Name</label>
          <input id="appName" name="appName" placeholder="z. B. BeispielApp">
        </div>
        <div class="fieldstack">
          <label for="version">Version</label>
          <input id="version" name="version" placeholder="z. B. 1.0.0">
        </div>
        <div class="fieldstack">
          <label for="category">Kategorie</label>
          <input id="category" name="category" placeholder="z. B. Gesundheit">
        </div>
      </fieldset>

      <fieldset>
        <legend>Antwortmöglichkeiten (Ja / Nein / Unbekannt)</legend>
        <div id="questions"></div>
      </fieldset>

      <div class="footer">
        <button type="submit" class="btn-primary">Bewerten</button>
      </div>
    </form>

    <!-- ERGEBNIS -->
    <section id="resultSection" class="score-card hidden" aria-live="polite">
      <div class="top-row">
        <div class="score-block">
          <div class="score-label">Gesamt-Score</div>
          <div id="scoreValue" class="score-value">0%</div>
          <div class="small-meta"><span id="correctMeta">0 von 0 richtigen Antworten</span></div>
        </div>
        <div class="grade-block">
          <div class="grade-label">Note</div>
          <div id="gradeBadge" class="grade-badge grade-F">F</div>
        </div>
      </div>

      <div class="progress-wrapper" aria-label="Score Fortschritt">
        <div class="progress-container">
          <div id="progressBar" class="progress-bar grade-F" style="width:0%;">
            <span id="progressText">0/0</span>
          </div>
        </div>
      </div>

      <div class="meta-grid">
        <div class="meta-col">
          <div class="section-title">App-Details</div>
          <div><span class="label-key">App-Name: </span><span id="rAppName">–</span></div>
          <div><span class="label-key">Version: </span><span id="rVersion">–</span></div>
          <div><span class="label-key">Kategorie: </span><span id="rCategory">–</span></div>
        </div>
        <div class="meta-col">
          <div class="section-title">Kurzbefunde</div>
          <div id="shortFindings"></div>
        </div>
      </div>

      <div class="footer">
        <button id="restartBtn" class="btn-primary" type="button">Neu bewerten</button>
      </div>
    </section>
  </div>

  <!-- Dein App-Logic-File -->
  <script src="./js/app.js"></script>

  <!-- Supabase-Login + Persistenz -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js";

    const SUPABASE_URL = "https://lhdztkfvrnsqfnbqybfq.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxoZHp0a2Z2cm5zcWZuYnF5YmZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczMjIxMjMsImV4cCI6MjA3Mjg5ODEyM30.81BVX5zf_WxE3RdTw32OttwsiMgDanXdNIkWeug-jUs";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

    // Login per E-Mail (Magic Link)
    document.getElementById('btnLoginEmail').addEventListener('click', async () => {
      const email = document.getElementById('emailInput').value.trim();
      const { error } = await supabase.auth.signInWithOtp({ email, options: {
      emailRedirectTo: 'https://mareenika.github.io/eazyscore-web/auth/callback/' // <- Magic-Links immer auf der Callback-Seite
    }                                                      
    });
      
      alert(error ? error.message : "Check deine E-Mail (Magic Link).");
    });
    
    // Login-Status
    async function updateStatus() {
      const { data: { user } } = await supabase.auth.getUser();
      document.getElementById('loginStatus').textContent =
        user ? `Eingeloggt: ${user.email}` : "";
      return user;
    }
    updateStatus();

    // Status nach Auth-Änderung automatisch aktualisieren
    supabase.auth.onAuthStateChange(() => updateStatus());

    // ===== Supabase-Helfer =====
    function slugify(s) {
      return s.toLowerCase().trim().replace(/[^a-z0-9]+/g, "-").replace(/(^-|-$)/g, "");
    }

    async function getOrCreateApp({ bundleId, name, category }) {
      let { data: apps, error } = await supabase
        .from("apps").select("*").eq("bundle_id", bundleId).limit(1);
      if (error) throw error;
      if (apps?.length) return apps[0];

      const { data, error: insErr } = await supabase
        .from("apps").insert({ bundle_id: bundleId, name, category }).select().single();
      if (insErr) throw insErr;
      return data;
    }

    async function saveAssessment({ appId, answers, totalScore, grade }) {
      const { error } = await supabase.from("assessments").insert({
        app_id: appId,
        answers,                 // YES/NO/UNKNOWN bleiben so gespeichert
        total_score: totalScore,
        grade
      });
      if (error) throw error;
    }

    // ===== Ergebnis aus app.js entgegennehmen und speichern =====
    document.addEventListener('eazy:result', async (ev) => {
      const user = await updateStatus();
      if (!user) { alert("Bitte zuerst einloggen, dann speichern."); return; }

      const { answers, score, grade, meta } = ev.detail;
      const { appName, version, category } = meta;

      // Fallback-Bundle-ID aus Name+Version
      const bundleId = slugify(`${appName || 'unbenannte-app'}-${version || 'v1'}`);

      try {
        const app = await getOrCreateApp({ bundleId, name: appName || 'Unbenannte App', category });
        await saveAssessment({ appId: app.id, answers, totalScore: score, grade });
        console.log("Gespeichert:", { appId: app.id, score, grade });
      } catch (e) {
        console.error(e);
        alert('Fehler beim Speichern: ' + (e?.message || e));
      }
    });
  </script>
</body>
</html>
