<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>EAZY Score</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="./css/style.css" rel="stylesheet">
  <style>
    form .question{display:flex;gap:12px;align-items:center;margin:.5rem 0;flex-wrap:wrap}
    .inline-label{min-width:280px;font-weight:600}
    .inline-field select,.inline-field input{padding:.5rem;border:1px solid #ccc;border-radius:6px}
    fieldset{border:1px solid #e2e8f0;border-radius:8px;padding:1rem;margin:1rem 0}
    legend{font-weight:700}
    .hidden{display:none}
    .footer{display:flex;justify-content:flex-start}
    .note{margin:.5rem 0;color:#555;font-size:.95em}
    .warn{color:#a33}
    .success{color:green}
  </style>
</head>
<body>
  <div class="container">
    <h1>EAZY Score</h1>

    <!-- Link zur öffentlichen Übersicht -->
    <p class="note">
      Öffentliche Liste ansehen: <a href="./public.html">Letzte Bewertungen</a>
    </p>

    <!-- LOGIN (OTP per E-Mail) -->
    <div id="loginBox" style="margin:1rem 0; border:1px solid #ddd; padding:1rem; border-radius:8px;">
      <div id="loginInputs">
        <label for="emailInput">E-Mail:
          <input id="emailInput" type="email" placeholder="you@example.com" required>
        </label>
        <button id="btnSendOtp" type="button">Code senden</button>

        <div style="margin-top:.75rem">
          <input id="otpInput" type="text" inputmode="numeric" maxlength="8" autocomplete="one-time-code" placeholder="8-stelliger Code">
          <button id="btnVerifyOtp" type="button">Code bestätigen</button>
        </div>

        <div id="loginHint" class="note"></div>
      </div>

      <!-- Status + Logout -->
      <div id="loginStatus" style="display:none; margin-top:.5rem; font-weight:600; color:green; align-items:center;">
        <span id="loginUser"></span>
        <button id="btnLogout" type="button" style="margin-left:1rem;">Logout</button>
      </div>
    </div>
    <!-- ENDE LOGIN -->

    <!-- Hinweis für Nicht-Admins -->
    <div id="adminNote" class="note warn hidden">
      Du bist eingeloggt, aber kein Admin. Bewertungen können nur Admins erstellen.
      Die Ergebnisse sind öffentlich hier sichtbar: <a href="./public.html">Letzte Bewertungen</a>.
    </div>

    <!-- FORMULAR (nur Admin sichtbar) -->
    <form id="auditForm" novalidate style="display:none;">
      <fieldset>
        <legend>App-Details</legend>
        <div class="fieldstack">
          <label for="appName">App-Name</label>
          <input id="appName" name="appName" placeholder="z. B. BeispielApp">
        </div>
        <div class="fieldstack">
          <label for="version">Version</label>
          <input id="version" name="version" placeholder="z. B. 1.0.0">
        </div>
        <div class="fieldstack">
          <label for="category">Kategorie</label>
          <input id="category" name="category" placeholder="z. B. Gesundheit">
        </div>
      </fieldset>

      <fieldset>
        <legend>Antwortmöglichkeiten (Ja / Nein / Unbekannt)</legend>
        <div id="questions"></div>
      </fieldset>

      <div class="footer">
        <button type="submit" class="btn-primary">Bewerten</button>
      </div>
    </form>

    <!-- ERGEBNIS -->
    <section id="resultSection" class="score-card hidden" aria-live="polite">
      <div class="top-row">
        <div class="score-block">
          <div class="score-label">Gesamt-Score</div>
          <div id="scoreValue" class="score-value">0%</div>
          <div class="small-meta"><span id="correctMeta">0 von 0 richtigen Antworten</span></div>
        </div>
        <div class="grade-block">
          <div class="grade-label">Note</div>
          <div id="gradeBadge" class="grade-badge grade-F">F</div>
        </div>
      </div>

      <div class="progress-wrapper" aria-label="Score Fortschritt">
        <div class="progress-container">
          <div id="progressBar" class="progress-bar grade-F" style="width:0%;">
            <span id="progressText">0/0</span>
          </div>
        </div>
      </div>

      <div class="meta-grid">
        <div class="meta-col">
          <div class="section-title">App-Details</div>
          <div><span class="label-key">App-Name: </span><span id="rAppName">–</span></div>
          <div><span class="label-key">Version: </span><span id="rVersion">–</span></div>
          <div><span class="label-key">Kategorie: </span><span id="rCategory">–</span></div>
        </div>
        <div class="meta-col">
          <div class="section-title">Kurzbefunde</div>
          <div id="shortFindings"></div>
        </div>
      </div>

      <div class="footer">
        <button id="restartBtn" class="btn-primary" type="button">Neu bewerten</button>
      </div>
    </section>
  </div>

  <!-- App-Logik -->
  <script src="./js/app.js"></script>

  <!-- Supabase-Login + Persistenz -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js";

    const supabase = createClient(
      "https://lhdztkfvrnsqfnbqybfq.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxoZHp0a2Z2cm5zcWZuYnF5YmZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczMjIxMjMsImV4cCI6MjA3Mjg5ODEyM30.81BVX5zf_WxE3RdTw32OttwsiMgDanXdNIkWeug-jUs"
    );

    // === UI Refs ===
    const loginBox   = document.getElementById('loginBox');
    const loginInputs= document.getElementById('loginInputs');
    const loginStatus= document.getElementById('loginStatus');
    const loginUser  = document.getElementById('loginUser');
    const btnLogout  = document.getElementById('btnLogout');
    const loginHint  = document.getElementById('loginHint');
    const emailEl    = document.getElementById('emailInput');
    const otpEl      = document.getElementById('otpInput');
    const sendBtn    = document.getElementById('btnSendOtp');
    const verifyBtn  = document.getElementById('btnVerifyOtp');
    const auditForm  = document.getElementById('auditForm');
    const adminNote  = document.getElementById('adminNote');

    // Enter im Login-Bereich soll NICHT das Formular abschicken
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && loginBox.contains(document.activeElement)) {
        e.preventDefault();
        e.stopPropagation();
        verifyBtn.click();
      }
    });

    let lastEmailSent = null;

    const normalizeEmail = v => (v || '').trim().toLowerCase();
    const cleanToken = v => (v||'').replace(/[^\d]/g,'').slice(0,8);

    function setLoggedInUI(identity) {
      loginInputs.style.display = 'none';
      loginStatus.style.display = 'flex';
      loginUser.textContent = `Eingeloggt: ${identity}`;
    }
    function setLoggedOutUI() {
      loginInputs.style.display = 'block';
      loginStatus.style.display = 'none';
      loginUser.textContent = '';
    }

    // OTP senden
    sendBtn.addEventListener('click', async () => {
      const email = normalizeEmail(emailEl.value);
      if (!email) return alert('Bitte E-Mail eingeben.');
      const { error } = await supabase.auth.signInWithOtp({ email });
      if (error) { alert(error.message); return; }
      lastEmailSent = email;
      loginHint.className = 'note success';
      loginHint.textContent = `Code an ${email} gesendet. Nutze den neuesten Code.`;
      alert('Code gesendet. Prüfe deine E-Mail.');
    });

    // OTP verifizieren (mit kleinen Fallbacks)
    verifyBtn.addEventListener('click', async () => {
      const email = normalizeEmail(emailEl.value);
      const token = cleanToken(otpEl.value);
      if (!email || token.length !== 8) return alert('E-Mail und 8-stelligen Code eingeben.');

      let lastErr = null;
      for (const type of ['email','signup','recovery']) {
        const { error } = await supabase.auth.verifyOtp({ email, token, type });
        if (!error) { lastErr = null; break; }
        lastErr = error;
        if (!/invalid|expired/i.test(error.message)) break;
      }
      if (lastErr) { alert(lastErr.message); return; }

      setLoggedInUI(email);
      await guardAdminUI();
    });

    // Logout
    btnLogout.addEventListener('click', async () => {
      await supabase.auth.signOut();
      setLoggedOutUI();
      auditForm.style.display = 'none';
      adminNote.classList.add('hidden');
    });

    // Admin-Check
    async function isAdmin() {
      const { data: { session } } = await supabase.auth.getSession();
      const uid = session?.user?.id;
      if (!uid) return false;
      const { data, error } = await supabase.from('admins').select('user_id').eq('user_id', uid).single();
      return !!data && !error;
    }

    async function guardAdminUI() {
      const admin = await isAdmin();
      if (admin) {
        auditForm.style.display = 'block';
        adminNote.classList.add('hidden');
      } else {
        auditForm.style.display = 'none';
        // Nur zeigen, wenn eingeloggt (sonst doppelte Hinweise)
        const { data: { session } } = await supabase.auth.getSession();
        if (session?.user) adminNote.classList.remove('hidden');
        else adminNote.classList.add('hidden');
      }
    }

    // Initial Status
    (async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (session?.user?.email) setLoggedInUI(session.user.email);
      await guardAdminUI();
    })();
    supabase.auth.onAuthStateChange(() => guardAdminUI());

    // === DB-Persistenz für Ergebnisse ===
    function slugify(s) {
      return (s||'').toLowerCase().trim().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");
    }

    async function getOrCreateApp({ bundleId, name, category }) {
      const { data: found, error: selErr } = await supabase
        .from("apps").select("*").eq("bundle_id", bundleId).limit(1);
      if (selErr) throw selErr;
      if (found && found.length) return found[0];
      const { data, error: insErr } = await supabase
        .from("apps").insert({ bundle_id: bundleId, name, category }).select().single();
      if (insErr) throw insErr;
      return data;
    }

    async function saveAssessment({ appId, answers, totalScore, grade }) {
      const { error } = await supabase
        .from("assessments")
        .insert({ app_id: appId, answers, total_score: Math.round(totalScore||0), grade });
      if (error) throw error;
    }

    document.addEventListener('eazy:result', async (ev) => {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session?.user) { alert("Bitte einloggen."); return; }

      try {
        const { answers, score, grade, meta } = ev.detail;
        const appName  = (meta?.appName || '').trim() || 'Unbenannte App';
        const version  = (meta?.version || '').trim() || 'v1';
        const category = (meta?.category || '').trim() || null;

        const bundleId = slugify(`${appName}-${version}`);
        const app = await getOrCreateApp({ bundleId, name: appName, category });
        await saveAssessment({ appId: app.id, answers, totalScore: score, grade });
        alert("Bewertung gespeichert.");
        console.log("✔ gespeichert:", { app: appName, score, grade });
      } catch (e) {
        console.error("❌ Speichern fehlgeschlagen:", e);
        alert("Fehler beim Speichern: " + (e?.message||e));
      }
    });
  </script>
</body>
</html>
