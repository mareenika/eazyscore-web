<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>EAZY Score</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="./css/style.css" rel="stylesheet">
  <style>
    form .question{display:flex;gap:12px;align-items:center;margin:.5rem 0;flex-wrap:wrap}
    .inline-label{min-width:280px;font-weight:600}
    .inline-field select,.inline-field input{padding:.5rem;border:1px solid #ccc;border-radius:6px}
    fieldset{border:1px solid #e2e8f0;border-radius:8px;padding:1rem;margin:1rem 0}
    legend{font-weight:700}
    .hidden{display:none}
    .footer{display:flex;justify-content:flex-start}
    .note{margin:.5rem 0;color:#555;font-size:.95em}
    .warn{color:#a33}
    .success{color:green}
  </style>
</head>
<body>
  <div class="container">
    <h1>EAZY Score</h1>

    <p class="note">
      Öffentliche Liste ansehen: <a href="./public.html">Letzte Bewertungen</a>
    </p>

    <!-- LOGIN -->
    <form id="loginForm" style="margin:1rem 0; border:1px solid #ddd; padding:1rem; border-radius:8px;">
      <label for="emailInput">E-Mail:
        <input id="emailInput" type="email" placeholder="you@example.com" required>
      </label>
      <label for="pwInput">Passwort:
        <input id="pwInput" type="password" required>
      </label>
      <button id="btnLogin" type="submit">Anmelden</button>
      <div id="loginHint" class="note"></div>
    </form>

    <!-- Status + Logout -->
    <div id="loginStatus" style="display:none; margin:1rem 0; font-weight:600; color:green; align-items:center;">
      <span id="loginUser"></span>
      <button id="btnLogout" type="button" style="margin-left:1rem;">Logout</button>
    </div>

    <!-- Hinweis für Nicht-Admins -->
    <div id="adminNote" class="note warn hidden">
      Du bist eingeloggt, aber kein Admin. Bewertungen können nur Admins erstellen.
      Ergebnisse siehst du hier: <a href="./public.html">Letzte Bewertungen</a>.
    </div>

    <!-- FORMULAR (nur Admin sichtbar) -->
    <form id="auditForm" novalidate style="display:none;">
      <fieldset>
        <legend>App-Details</legend>
        <div class="fieldstack">
          <label for="appName">App-Name</label>
          <input id="appName" name="appName" placeholder="z. B. BeispielApp">
        </div>
        <div class="fieldstack">
          <label for="version">Version</label>
          <input id="version" name="version" placeholder="z. B. 1.0.0">
        </div>
        <div class="fieldstack">
          <label for="category">Kategorie</label>
          <input id="category" name="category" placeholder="z. B. Gesundheit">
        </div>
      </fieldset>

      <fieldset>
        <legend>Antwortmöglichkeiten (Ja / Nein / Unbekannt)</legend>
        <div id="questions"></div>
      </fieldset>

      <div class="footer">
        <button type="submit" class="btn-primary">Bewerten</button>
      </div>
    </form>
  </div>

  <!-- Supabase Login -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js";

    const supabase = createClient(
      "https://lhdztkfvrnsqfnbqybfq.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxoZHp0a2Z2cm5zcWZuYnF5YmZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczMjIxMjMsImV4cCI6MjA3Mjg5ODEyM30.81BVX5zf_WxE3RdTw32OttwsiMgDanXdNIkWeug-jUs"
    );

    const loginForm  = document.getElementById('loginForm');
    const loginHint  = document.getElementById('loginHint');
    const loginUser  = document.getElementById('loginUser');
    const loginStatus= document.getElementById('loginStatus');
    const btnLogout  = document.getElementById('btnLogout');
    const auditForm  = document.getElementById('auditForm');
    const adminNote  = document.getElementById('adminNote');

    function setLoggedInUI(isAdmin) {
      loginForm.style.display = 'none';
      loginStatus.style.display = 'flex';
      loginUser.textContent = isAdmin ? "Superadmin" : "Eingeloggt";
    }
    function setLoggedOutUI() {
      loginForm.style.display = 'block';
      loginStatus.style.display = 'none';
      loginUser.textContent = '';
      auditForm.style.display = 'none';
      adminNote.classList.add('hidden');
    }

    async function isAdmin() {
      const { data: { session } } = await supabase.auth.getSession();
      const uid = session?.user?.id;
      if (!uid) return false;
      const { data, error } = await supabase.from('admins').select('user_id').eq('user_id', uid).maybeSingle();
      return !!data && !error;
    }

    async function guardAdminUI() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session?.user) { setLoggedOutUI(); return; }
      if (await isAdmin()) {
        setLoggedInUI(true);
        auditForm.style.display = 'block';
        adminNote.classList.add('hidden');
      } else {
        setLoggedInUI(false);
        auditForm.style.display = 'none';
        adminNote.classList.remove('hidden');
      }
    }

    // Login Submit
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('emailInput').value.trim();
      const pw    = document.getElementById('pwInput').value.trim();
      if (!email || !pw) return alert("Bitte E-Mail und Passwort eingeben");

      const { error } = await supabase.auth.signInWithPassword({ email, password: pw });
      if (error) { loginHint.textContent = error.message; return; }

      await guardAdminUI();
    });

    // Logout
    btnLogout.addEventListener('click', async () => {
      await supabase.auth.signOut();
      setLoggedOutUI();
    });

    // Status bei Laden
    (async () => {
      await guardAdminUI();
    })();
  </script>
</body>
</html>
